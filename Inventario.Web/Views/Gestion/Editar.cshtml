@using System.Globalization


@model Inventario.Web.Models.Gestion.EditarGestionViewModel


@{
    ViewData["Title"] = "Editar productos";
}

@section Styles {
    <link rel="stylesheet" href="~/css/Editar.css" />
}

<div class="gestion-editar">

    <!-- ENCABEZADO -->
    <div class="gestion-editar__header">
        <h2 class="gestion-editar__title">✏️ Editar productos</h2>
        <p class="gestion-editar__subtitle">
            Busca un producto y edita su información
        </p>
    </div>

    <!-- 🔍 BUSCADOR -->
    <form method="get" class="gestion-editar__busqueda">
        <input type="text"
               name="busqueda"
               value="@Model.Busqueda"
               placeholder="Buscar producto..."
               class="form-control" />
        <button type="submit" class="btn btn-secondary">
            🔍 Buscar
        </button>
    </form>

    <div class="row mt-4">

        <!-- 📋 COLUMNA IZQUIERDA: TABLA -->
        <div class="col-md-7">

            <div class="gestion-editar__tabla-container">

                <div class="gestion-editar__tabla-header">
                    📦 Productos disponibles
                </div>

                <div class="gestion-editar__tabla-scroll">

                    <table class="table gestion-editar__tabla">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Precio</th>
                                <th>Stock</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var producto in Model.Productos)
                            {
                                <tr>
                                    <td>@producto.Nombre</td>
                                    <td>@producto.Precio</td>
                                    <td>@producto.Stock</td>
                                    <td>
                                        <button type="button"
                                                class="btn btn-sm btn-primary btn-editar"
                                                data-id="@producto.Id"
                                                data-nombre="@producto.Nombre"
                                                data-descripcion="@producto.Descripcion"
                                                data-precio="@producto.Precio"
                                                data-stock="@producto.Stock">
                                            ✏️ Editar
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>

                </div>

            </div>

        </div>


        <!-- 📝 COLUMNA DERECHA: FORMULARIO -->
        <div class="col-md-5">

            <div class="gestion-editar__form-card">

                <div id="form-editar" style="display:none;">

                    <h5 class="mb-3">✏️ Editar producto</h5>

                    <form asp-action="Editar" method="post">

                        @Html.AntiForgeryToken()

                        <input type="hidden" name="Id" id="edit-id" />

                        <div class="mb-3">
                            <label class="form-label">Nombre</label>
                            <input name="Nombre" id="edit-nombre" class="form-control" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Descripción</label>
                            <textarea name="Descripcion" id="edit-descripcion" class="form-control"></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Precio</label>
                                <input name="Precio" id="edit-precio" type="number" step="0.01" class="form-control" />
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">Stock</label>
                                <input name="Stock" id="edit-stock" type="number" class="form-control" />
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success">
                                💾 Guardar cambios
                            </button>

                            <button type="button" class="btn btn-secondary" onclick="cerrarEditar()">
                                Cancelar
                            </button>
                        </div>

                    </form>

                </div>

            </div>

        </div>


    </div>

    <a asp-action="Gestion"
       class="btn btn-secondary mt-3">
        Volver
    </a>

</div>

<script>
    function normalizarNumero(valor) {
        if (!valor) return 0;
        valor = valor.replace(/\./g, "");
        valor = valor.replace(",", ".");
        return Number(valor);
    }

    document.addEventListener("DOMContentLoaded", function () {

        const botones = document.querySelectorAll(".btn-editar");
        const form = document.getElementById("form-editar");

        botones.forEach(boton => {
            boton.addEventListener("click", function () {

                form.style.display = "block";

                document.getElementById("edit-id").value = this.dataset.id;
                document.getElementById("edit-nombre").value = this.dataset.nombre;
                document.getElementById("edit-descripcion").value = this.dataset.descripcion;

                const precioNormalizado = normalizarNumero(this.dataset.precio);
                document.getElementById("edit-precio").value = precioNormalizado;

                document.getElementById("edit-stock").value = this.dataset.stock;
            });
        });
    });

    function cerrarEditar() {
        document.getElementById("form-editar").style.display = "none";
    }
</script>

<script>
    function buscarEnTabla() {
        const texto = document.querySelector("input[name='busqueda']")
            .value.toLowerCase();

        let encontrado = false;

        document.querySelectorAll("tbody tr").forEach(fila => {
            fila.classList.remove("table-warning");

            if (!texto) return;

            if (fila.dataset.nombre.includes(texto) && !encontrado) {
                fila.classList.add("table-warning");
                fila.scrollIntoView({ behavior: "smooth", block: "center" });
                encontrado = true;
            }
        });

        if (!encontrado && texto) {
            alert("Producto no encontrado");
        }
    }
</script>




